<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>A clumsy Docker network notes | kiennt26's home</title><link rel=apple-touch-icon sizes=57x57 href=/favicon_io/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon_io/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon_io/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon_io/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon_io/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon_io/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon_io/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon_io/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon_io/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon_io/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon_io/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon_io/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon_io/favicon-16x16.png><link rel=manifest href=/favicon_io/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon_io/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/css/main.min.7c2e3acb1f4933aa19f3729495445482ab9d9dc0c28c00c85831559d823fd2e7.css integrity="sha256-fC46yx9JM6oZ83KUlURUgqudncDCjADIWDFVnYI/0uc=" crossorigin=anonymous><link rel=stylesheet href=/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=" crossorigin=anonymous><script src=/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js integrity="sha256-I80MfYNyY7nq65buLZzPopadqj+gD6HB/ocBqbhyUaE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script></head><body><header><header><nav class=path-nav><ol><li>/
<a href=/>kiennt26's home</a>
/</li><li><a href=/posts/>Posts</a>
/</li><li class=current><a href=/posts/clumsy-docker-network-notes/>A clumsy Docker network notes</a></li></ol></nav></header></header><main><h1>A clumsy Docker network notes</h1><div class=terms-list><ul><li><a href=/tags/tech/>#Tech</a></li><li><a href=/tags/docker/>#Docker</a></li></ul></div><nav class=toc><strong>Table of contents</strong><div class=toc-content><nav id=TableOfContents><ol><li><a href=#khái-niệm>Khái niệm</a></li><li><a href=#docker-và-network-namespace>Docker và network namespace</a></li><li><a href=#tản-mạn-qua-docker-networking-subsystem>Tản mạn qua Docker networking subsystem</a><ol><li><a href=#docker0---default-bridge-network>docker0 - default bridge network</a></li><li><a href=#user-defined-bridge-network>User-defined bridge network</a></li></ol></li><li><a href=#một-số-command-hay-ho>Một số command hay ho</a></li></ol></nav></div></nav><h1 id=a-clumsy-docker-networking-notes>A clumsy Docker networking notes</h1><p>Nguồn:</p><ul><li><a href=https://github.com/ntk148v/til/tree/master/docker/networking>https://github.com/ntk148v/til/tree/master/docker/networking</a></li><li><a href=https://argus-sec.com/docker-networking-behind-the-scenes/>https://argus-sec.com/docker-networking-behind-the-scenes/</a></li><li><a href=https://docs.docker.com/network/>https://docs.docker.com/network/</a></li><li><a href=https://github.com/KamranAzeem/learn-docker/blob/master/docs/docker-networking-deep-dive.md>https://github.com/KamranAzeem/learn-docker/blob/master/docs/docker-networking-deep-dive.md</a></li><li><a href=https://docs.docker.com/engine/tutorials/networkingcontainers/>https://docs.docker.com/engine/tutorials/networkingcontainers/</a></li><li><a href=https://docs.docker.com/network/iptables/>https://docs.docker.com/network/iptables/</a></li><li><a href=https://dev.to/polarbit/how-docker-container-networking-works-mimic-it-using-linux-network-namespaces-9mj>https://dev.to/polarbit/how-docker-container-networking-works-mimic-it-using-linux-network-namespaces-9mj</a></li></ul><h2 id=khái-niệm>Khái niệm</h2><ul><li><p>Các khái niệm:</p><ul><li><p><a href=https://man7.org/linux/man-pages/man8/ip-netns.8.html>Network namespace</a>:</p><ul><li>Trước khi đi vào network namespace, cần hiểu về <strong>Namespace</strong>. Namespace là một tính năng của Linux kernel để phân vùng tài nguyên của kernel sao cho một tập hợp các process chỉ nhìn thấy tập hợp các tài nguyên (trong namespace đó) trong khi một tập hợp các process khác nhìn thấy tập các tài nguyên khác (trong namespace khác). Tính năng này hoạt động bằng cách đưa tập các tài nguyên và process vào cùng một namespace, các namespace khác nhau sẽ tham chiếu đến các tài nguyên riêng biệt. Tài nguyên có thể tồn tại trong nhiều không gian. Ví dụ về các tài nguyên như vậy là process ID, hostname, user ID, tên file và một số tên (name) liên quan đến quyền truy cập mạng và giao tiếp giữa các process.</li><li>Networking namespace là một trong các loại namespace. Mỗi network namespace có <a href=https://en.wikipedia.org/wiki/Network_stack>network stack</a> riêng: địa chỉ IP, network interface, route table, &mldr;</li><li>Bạn có thể xem thao tác các network namespace bằng câu lệnh sau:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ip netns &lt;sub-command&gt;
</span></span></code></pre></div></li><li><p><a href=https://wiki.archlinux.org/index.php/Network_bridge>Network bridge</a>: một thiết bị mạng ảo chuyển tiếp các gói giữa hai hoặc nhiều phân đoạn mạng.</p></li><li><p><strong>Veth pair</strong>: hiểu đơn giản là virtual network cable nối giữa 2 network interface device (NIC).</p></li></ul></li><li><p>Về cơ bản, Docker sử dụng các tính năng trên như sau:</p></li></ul><p><img src=https://res.cloudinary.com/practicaldev/image/fetch/s--tGvJLH6y--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/pszchqfvcjpl13dextrc.png alt></p><h2 id=docker-và-network-namespace>Docker và network namespace</h2><blockquote><p>Ví dụ sau lấy theo các thông số, cấu hình mặc định khi chạy Docker container.</p></blockquote><ul><li>Khi tạo và chạy 1 container, Docker đồng thời tạo ra một network namespace riêng cho container đó. Sau đó, Docker kết nối network của container đó với Linux bridge <strong>docker0</strong> bằng veth pair.</li><li>Như ở trên đã nói, để xem danh sách network namespace, gõ câu lệnh sau:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ip netns list
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Start a container</span>
</span></span><span style=display:flex><span>$ docker run --name nstest -it busybox
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Open another terminal session</span>
</span></span><span style=display:flex><span>$ sudo ip netns list
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># nothing return</span>
</span></span></code></pre></div><ul><li>Hmm, không có gì trả về. Mặc định Docker không thêm container network namespace vào trong Linux runtime data, bạn có thể tạo softlink cho network namespace đó:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#888;font-style:italic># Get container process id.</span>
</span></span><span style=display:flex><span>$ <span style=color:#666;font-weight:700;font-style:italic>pid</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=font-weight:700>$(</span>docker inspect -f <span style=color:#666;font-style:italic>&#39;{{.State.Pid}}&#39;</span> nstest<span style=font-weight:700>)</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Soft link the network namespace</span>
</span></span><span style=display:flex><span>$ sudo mkdir -p /var/run/netns/
</span></span><span style=display:flex><span>$ sudo ln -sf /proc/<span style=color:#666;font-weight:700;font-style:italic>$pid</span>/ns/net /var/run/netns/nstest
</span></span><span style=display:flex><span>$ sudo ip netns list
</span></span><span style=display:flex><span>nstest (id: 0)
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ^ this, it works.</span>
</span></span></code></pre></div><ul><li>Chạy vào network namespace, như đã nói, mỗi network namespace có network stack riêng:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker <span style=font-weight:700;font-style:italic>exec</span> nstest ip a
</span></span><span style=display:flex><span>docker <span style=font-weight:700;font-style:italic>exec</span> nstest ip a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue
</span></span><span style=display:flex><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ip netns <span style=font-weight:700;font-style:italic>exec</span> nstest ip a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
</span></span><span style=display:flex><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style=display:flex><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ^ result is the same as docker exec command.</span>
</span></span><span style=display:flex><span>$ ip a | grep docker
</span></span><span style=display:flex><span>5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
</span></span><span style=display:flex><span>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
</span></span><span style=display:flex><span>8: veth4866e91@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default
</span></span></code></pre></div><ul><li>Ở đây, eth0@if8 trong container namespace đang kết nối với interface veth4866e91@if7 trên docker0 bridge.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>docker0         8000.0242f0c749bd       no              veth4866e91 <span style=color:#888;font-style:italic># this</span>
</span></span><span style=display:flex><span>lxdbr0          8000.00163e2afe62       no
</span></span></code></pre></div><h2 id=tản-mạn-qua-docker-networking-subsystem>Tản mạn qua Docker networking subsystem</h2><p>Kiến trúc Docker networking subsystem dạng pluggable, có thể mở rộng sử dụng drivers. Mặc định, có những drivers sau: <code>bridge</code>, <code>host</code>, <code>none</code>, <code>overlay</code>, <code>macvlan</code>, <code>ipvlan</code>.</p><p>Trong bài viết này, chủ yếu nói đến <code>bridge</code> driver.</p><h3 id=docker0---default-bridge-network>docker0 - default bridge network</h3><p><img src=https://docs.docker.com/engine/tutorials/bridge1.png alt></p><ul><li>Mặc định, tất cả container đều kết nối với docker0.</li><li>Docker engine khi start up sẽ tìm một subnet không được sử dụng (bắt đầu trong một danh sách fixed trong code) và gán IP đầu tiên cho docker0. Như trong trường hợp của tui, đó là <code>172.17.0.1/16</code>.</li><li>Nếu không có containers nào chạy và kết nối với docker0, trạng thái của docker0 là DOWN.</li><li>Các containers kết nối với docker0, kế thừa cấu hình DNS của host: <code>/etc/hosts</code> and <code>/etc/resolv.conf</code>.</li><li>Lưu ý, ở docker0 bridge, không có tính năng <strong>service discovery</strong>, do vậy, các containers phải giao tiếp thông qua địa chỉ IP.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#888;font-style:italic># Start a second container</span>
</span></span><span style=display:flex><span>$ docker run --name nstest2 -it busybox
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ip a</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue
</span></span><span style=display:flex><span>    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ping nstest</span>
</span></span><span style=display:flex><span>ping: bad address <span style=color:#666;font-style:italic>&#39;nstest&#39;</span>
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ping 172.17.0.2</span>
</span></span><span style=display:flex><span>PING 172.17.0.2 (172.17.0.2): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 172.17.0.2: <span style=color:#666;font-weight:700;font-style:italic>seq</span>=0 <span style=color:#666;font-weight:700;font-style:italic>ttl</span>=64 <span style=color:#666;font-weight:700;font-style:italic>time</span>=0.263 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.17.0.2 ping statistics ---
</span></span><span style=display:flex><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max = 0.263/0.263/0.263 ms
</span></span></code></pre></div><h3 id=user-defined-bridge-network>User-defined bridge network</h3><ul><li>Người dùng có thể tự tạo Docker network.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker network create mynet
</span></span><span style=display:flex><span>ed7da300a506e6e9be68b8f69d1b857dd7cc8db2a9d51c4b85dba37976780293
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker network ls
</span></span><span style=display:flex><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style=display:flex><span>935865833d99   bridge    bridge    <span style=font-weight:700;font-style:italic>local</span>
</span></span><span style=display:flex><span>f753aeafa1a1   host      host      <span style=font-weight:700;font-style:italic>local</span>
</span></span><span style=display:flex><span>ed7da300a506   mynet     bridge    <span style=font-weight:700;font-style:italic>local</span>
</span></span><span style=display:flex><span>6b0488ceccc8   none      null      <span style=font-weight:700;font-style:italic>local</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker network inspect mynet
</span></span><span style=display:flex><span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Name&#34;</span>: <span style=color:#666;font-style:italic>&#34;mynet&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Id&#34;</span>: <span style=color:#666;font-style:italic>&#34;ed7da300a506e6e9be68b8f69d1b857dd7cc8db2a9d51c4b85dba37976780293&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Created&#34;</span>: <span style=color:#666;font-style:italic>&#34;2023-12-12T09:37:34.358888862+07:00&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Scope&#34;</span>: <span style=color:#666;font-style:italic>&#34;local&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Driver&#34;</span>: <span style=color:#666;font-style:italic>&#34;bridge&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;EnableIPv6&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;IPAM&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#666;font-style:italic>&#34;Driver&#34;</span>: <span style=color:#666;font-style:italic>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#666;font-style:italic>&#34;Options&#34;</span>: {},
</span></span><span style=display:flex><span>            <span style=color:#666;font-style:italic>&#34;Config&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#666;font-style:italic>&#34;Subnet&#34;</span>: <span style=color:#666;font-style:italic>&#34;172.18.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#666;font-style:italic>&#34;Gateway&#34;</span>: <span style=color:#666;font-style:italic>&#34;172.18.0.1&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Internal&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Attachable&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Ingress&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;ConfigFrom&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#666;font-style:italic>&#34;Network&#34;</span>: <span style=color:#666;font-style:italic>&#34;&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;ConfigOnly&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Containers&#34;</span>: {},
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Options&#34;</span>: {},
</span></span><span style=display:flex><span>        <span style=color:#666;font-style:italic>&#34;Labels&#34;</span>: {}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Check with ip addr show, it should show up as a network</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># inteface on the host with the name br-&lt;Network ID substring&gt;</span>
</span></span><span style=display:flex><span>$ ip addr show
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ...</span>
</span></span><span style=display:flex><span>11: br-ed7da300a506: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
</span></span><span style=display:flex><span>    link/ether 02:42:f8:36:9b:e0 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-ed7da300a506
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br-ed7da300a506 8000.0242f8369be0       no
</span></span><span style=display:flex><span>docker0         8000.0242f0c749bd       no
</span></span><span style=display:flex><span>lxdbr0          8000.00163e2afe62       no
</span></span></code></pre></div><ul><li>Không giống docker0 bridge, network mới có DNS-based service discovery:<ul><li>Ở đây, sử dụng custom image <code>praqma/network-multitool</code> để có đủ commands và tools, có thể sử dụng image bất kỳ và cài đặt tool tương tự.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker run --name=web --network=mynet -d wbitt/network-multitool
</span></span><span style=display:flex><span>e2d841b7a02916aa25a2fa5ceace0427ad7c0ccc967ad01fb5cc423460f0e990
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker run --name=db --network=mynet -e <span style=color:#666;font-weight:700;font-style:italic>MYSQL_ROOT_PASSWORD</span>=secret -d mysql
</span></span><span style=display:flex><span>492ba8a9277d96876f0a605d9434723aed774978a40023e778a97815216754f0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                     COMMAND                  CREATED              STATUS              PORTS                                  NAMES
</span></span><span style=display:flex><span>e2d841b7a029   wbitt/network-multitool   <span style=color:#666;font-style:italic>&#34;/bin/sh /docker/ent…&#34;</span>   15 seconds ago       Up 14 seconds       80/tcp, 443/tcp, 1180/tcp, 11443/tcp   web
</span></span><span style=display:flex><span>492ba8a9277d   mysql                     <span style=color:#666;font-style:italic>&#34;docker-entrypoint.s…&#34;</span>   About a minute ago   Up About a minute   3306/tcp, 33060/tcp                    db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Ping each other</span>
</span></span><span style=display:flex><span>$ docker <span style=font-weight:700;font-style:italic>exec</span> -it web bash
</span></span><span style=display:flex><span>e2d841b7a029:/# ping -c 1 db
</span></span><span style=display:flex><span>PING db (172.18.0.2) 56(84) bytes of data.
</span></span><span style=display:flex><span>64 bytes from db.mynet (172.18.0.2): <span style=color:#666;font-weight:700;font-style:italic>icmp_seq</span>=1 <span style=color:#666;font-weight:700;font-style:italic>ttl</span>=64 <span style=color:#666;font-weight:700;font-style:italic>time</span>=0.096 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- db ping statistics ---
</span></span><span style=display:flex><span>1 packets transmitted, 1 received, 0% packet loss, <span style=font-weight:700;font-style:italic>time</span> 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev = 0.096/0.096/0.096/0.000 ms
</span></span><span style=display:flex><span>e2d841b7a029:/# dig db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.16 &lt;&lt;&gt;&gt; db
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#666;font-style:italic>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: 57615
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;db.                            IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>db.                     600     IN      A       172.18.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 127.0.0.11#53(127.0.0.11) (UDP)
</span></span><span style=display:flex><span>;; WHEN: Tue Dec 12 03:18:39 UTC 2023
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 38
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e2d841b7a029:/#
</span></span></code></pre></div><ul><li>Tại sao có thể thao tác phân giải tên container như vậy? Đó là nhờ một <strong>DNS nhúng</strong> ở trong Docker service.</li></ul><p><img src=https://github.com/KamranAzeem/learn-docker/raw/master/docs/images/docker-service-discovery-2.png alt></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>e2d841b7a029:/# cat /etc/resolv.conf
</span></span><span style=display:flex><span>nameserver 127.0.0.11
</span></span><span style=display:flex><span>options edns0 trust-ad ndots:0
</span></span><span style=display:flex><span>e2d841b7a029:/# netstat -ntlup
</span></span><span style=display:flex><span>Active Internet connections (only servers)
</span></span><span style=display:flex><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span style=display:flex><span>tcp        0      0 127.0.0.11:45541        0.0.0.0:*               LISTEN      -
</span></span><span style=display:flex><span>tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      1/nginx: master pro
</span></span><span style=display:flex><span>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      1/nginx: master pro
</span></span><span style=display:flex><span>udp        0      0 127.0.0.11:42758        0.0.0.0:*                           -
</span></span></code></pre></div><ul><li><code>/etc/resolv.conf</code> cho thấy container đang trỏ về nameserver 127.0.0.11:53 nhưng rõ ràng không có tiến trình nào lắng nghe port 53 cả. Vậy DNS này hoạt động như thế nào?</li><li>Tiếp tục, tạo thêm 1 container khác, nhưng có nhiều <strong>quyền</strong> hơn.<ul><li><code>iptables</code> chỉ chạy khi có capabilities <code>-cap-add=NET_ADMIN and --cap-add=NET_RAW</code>.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker run <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>    --name tool <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>    --network mynet <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>    --cap-add=NET_ADMIN <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>    --cap-add=NET_RAW <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>    -it wbitt/network-multitool /bin/bash
</span></span><span style=display:flex><span>ccd72fe225c8:/# dig -c db
</span></span><span style=display:flex><span>;; Warning, ignoring invalid class db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.16 &lt;&lt;&gt;&gt; -c db
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#666;font-style:italic>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: 17778
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 65494
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;.                              IN      NS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>.                       31133   IN      NS      d.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      l.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      k.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      i.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      j.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      e.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      h.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      g.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      a.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      f.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      c.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      b.root-servers.net.
</span></span><span style=display:flex><span>.                       31133   IN      NS      m.root-servers.net.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 8 msec
</span></span><span style=display:flex><span>;; SERVER: 127.0.0.11#53(127.0.0.11) (UDP)
</span></span><span style=display:flex><span>;; WHEN: Tue Dec 12 03:20:07 UTC 2023
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 239
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ccd72fe225c8:/# netstat -ntlup
</span></span><span style=display:flex><span>Active Internet connections (only servers)
</span></span><span style=display:flex><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span style=display:flex><span>tcp        0      0 127.0.0.11:39527        0.0.0.0:*               LISTEN      -
</span></span><span style=display:flex><span>udp        0      0 127.0.0.11:35031        0.0.0.0:*                           -
</span></span><span style=display:flex><span>ccd72fe225c8:/# iptables-nft-save
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Generated by iptables-nft-save v1.8.9 (nf_tables) on Tue Dec 12 03:20:27 2023</span>
</span></span><span style=display:flex><span>*nat
</span></span><span style=display:flex><span>:PREROUTING ACCEPT [0:0]
</span></span><span style=display:flex><span>:INPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:OUTPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:POSTROUTING ACCEPT [0:0]
</span></span><span style=display:flex><span>:DOCKER_OUTPUT - [0:0]
</span></span><span style=display:flex><span>:DOCKER_POSTROUTING - [0:0]
</span></span><span style=display:flex><span>-A OUTPUT -d 127.0.0.11/32 -j DOCKER_OUTPUT
</span></span><span style=display:flex><span>-A POSTROUTING -d 127.0.0.11/32 -j DOCKER_POSTROUTING
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Queries for DNS:</span>
</span></span><span style=display:flex><span>-A DOCKER_OUTPUT -d 127.0.0.11/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.11:39527
</span></span><span style=display:flex><span>-A DOCKER_OUTPUT -d 127.0.0.11/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.11:35031
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Response from DNS:</span>
</span></span><span style=display:flex><span>-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p tcp -m tcp --sport 39527 -j SNAT --to-source :53
</span></span><span style=display:flex><span>-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 35031 -j SNAT --to-source :53
</span></span><span style=display:flex><span>COMMIT
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Completed on Tue Dec 12 03:20:27 2023</span>
</span></span></code></pre></div><ul><li><strong>iptables</strong> does magic thing! Mọi DNS query đến <code>127.0.0.11:53</code> thực tế được điều hướng sang <code>127.0.0.11:39527</code> (TCP) và <code>127.0.0.11:35031</code> (UDP).<ul><li>Thông thường, DNS sử dụng UDP cho queries nhỏ hơn 512 bytes, trên 512 bytes -> TCP.</li></ul></li></ul><p><img src=https://github.com/KamranAzeem/learn-docker/raw/master/docs/images/docker-service-discovery-1.png alt></p><blockquote><p><strong>Lưu ý</strong>: Port trên hình có thể khác với thực tế.</p></blockquote><ul><li>Chi tiết về implementation có thể tham khảo ở đây:<ul><li><a href=https://github.com/moby/moby/blob/65973c6c40a32380f4f7318de92eb6c8161742f0/daemon/container_operations_unix.go#L398>container_operations_unix.go</a></li><li><a href=https://github.com/moby/moby/blob/65973c6c40a32380f4f7318de92eb6c8161742f0/libnetwork/resolver_unix.go#L13>resolver_unix.go</a></li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=font-weight:700>case</span> container.HostConfig.NetworkMode.<span style=color:#666;font-weight:700;font-style:italic>IsUserDefined</span>():
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// The container uses a user-defined network. We use the embedded DNS</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// server for container name resolution and to act as a DNS forwarder</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// for external DNS resolution.</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// We parse the DNS server(s) that are defined in /etc/resolv.conf on</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// the host, which may be a local DNS server (for example, if DNSMasq or</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// systemd-resolvd are in use). The embedded DNS server forwards DNS</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// resolution to the DNS server configured on the host, which in itself</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// may act as a forwarder for external DNS servers.</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// If systemd-resolvd is used, the &#34;upstream&#34; DNS servers can be found in</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// /run/systemd/resolve/resolv.conf. We do not query those DNS servers</span>
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// directly, as they can be dynamically reconfigured.</span>
</span></span><span style=display:flex><span>		*sboxOptions = <span style=font-weight:700;font-style:italic>append</span>(
</span></span><span style=display:flex><span>			*sboxOptions,
</span></span><span style=display:flex><span>			libnetwork.<span style=color:#666;font-weight:700;font-style:italic>OptionOriginResolvConfPath</span>(<span style=color:#666;font-style:italic>&#34;/etc/resolv.conf&#34;</span>),
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	<span style=font-weight:700>default</span>:
</span></span></code></pre></div><h2 id=một-số-command-hay-ho>Một số command hay ho</h2><ul><li>Join container vào process namespace của container khác.<ul><li>Có thể thấy process mysqld của container db.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker run --name busybox <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>                 --pid container:db <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>                 --rm -it busybox /bin/sh
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ps aux</span>
</span></span><span style=display:flex><span>PID   USER     TIME  COMMAND
</span></span><span style=display:flex><span>    1 999       0:25 mysqld
</span></span><span style=display:flex><span>  237 root      0:00 /bin/sh
</span></span><span style=display:flex><span>  243 root      0:00 ps aux
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ip a</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>48: eth0@if49: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue
</span></span><span style=display:flex><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><ul><li>Join thêm network namespace.<ul><li>Địa chỉ IP đang là 172.18.0.2/16 (db network namespace).</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --name busybox <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>                 --pid container:db <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>                 --network container:db --rm -it busybox /bin/sh
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ip a</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>38: eth0@if39: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue
</span></span><span style=display:flex><span>    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic># ps aux</span>
</span></span><span style=display:flex><span>PID   USER     TIME  COMMAND
</span></span><span style=display:flex><span>    1 999       0:26 mysqld
</span></span><span style=display:flex><span>  245 root      0:00 /bin/sh
</span></span><span style=display:flex><span>  252 root      0:00 ps aux
</span></span><span style=display:flex><span>/ <span style=color:#888;font-style:italic>#</span>
</span></span></code></pre></div><time datetime=2023-12-12>2023-12-12&nbsp;</time><div class=terminal-nav><div class=back-nav><a href=../ class=back-link>../</a></div></div></main><footer><p>&copy; Copyright 2025 &#183;
<a href=https://github.com/ntk148v/shibui>shibui</a></p></footer></body></html>