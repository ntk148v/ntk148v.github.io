<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Docker and Iptables: You may do it wrong! | kiennt26's home</title><link rel=apple-touch-icon sizes=57x57 href=/favicon_io/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon_io/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon_io/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon_io/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon_io/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon_io/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon_io/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon_io/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon_io/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon_io/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon_io/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon_io/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon_io/favicon-16x16.png><link rel=manifest href=/favicon_io/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon_io/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/css/main.min.bfa225829232a1fd0fe881e1a63085c17a6f96c27228455903fb93bed9ed5a76.css integrity="sha256-v6IlgpIyof0P6IHhpjCFwXpvlsJyKEVZA/uTvtntWnY=" crossorigin=anonymous><link rel=stylesheet href=/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=" crossorigin=anonymous><script src=/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js integrity="sha256-I80MfYNyY7nq65buLZzPopadqj+gD6HB/ocBqbhyUaE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script></head><body><header><header><nav class=path-nav><ol><li>/
<a href=/>kiennt26's home</a>
/</li><li><a href=/posts/>Posts</a>
/</li><li class=current><a href=/posts/docker-iptables/>Docker and Iptables: You may do it wrong!</a></li></ol></nav></header></header><main><h1>Docker and Iptables: You may do it wrong!</h1><div class=terms-list><ul><li><a href=/tags/tech/>#Tech</a></li><li><a href=/tags/docker/>#Docker</a></li><li><a href=/tags/iptables/>#Iptables</a></li></ul></div><nav class=toc><strong>Table of contents</strong><div class=toc-content><nav id=TableOfContents><ol><li><a href=#mission>Mission</a></li><li><a href=#docker-network>Docker network</a></li><li><a href=#you-may-do-it-wrong---common-mistakes>You may do it wrong - common mistakes</a><ol><li><a href=#modify-docker-generated-rules-manually>Modify Docker generated rules manually</a></li><li><a href=#insert-you-rules-in-the-wrong-chain>Insert you rules in the wrong chain</a></li><li><a href=#modify-and-persistent-iptables-wrong>Modify and persistent iptables wrong</a></li></ol></li><li><a href=#do-it-right>Do it right!</a><ol><li><a href=#overview>Overview</a></li><li><a href=#getting-started>Getting started</a></li></ol></li><li><a href=#references>References</a></li></ol></nav></div></nav><h2 id=mission>Mission</h2><p>If you&rsquo;re running Docker on a host that is exposed to the Internet (network bridge), you will probably want to restrict external access.</p><h2 id=docker-network>Docker network</h2><p>Let&rsquo;s start with a fact that Docker manipulates <code>iptables</code> rules to provide network isolation, on Linux. Docker installs custom iptables chains named <code>DOCKER</code>, <code>DOCKER-USER</code> and <code>DOCKER-ISOLATION-STAGE-*</code>, and it ensures that incoming packets are always checked by these chains first.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables -L -n
</span></span></code></pre></div><p>Re.Docker network, I won&rsquo;t describe here because it&rsquo;s a lot of knowledge. You may want to check <a href=https://github.com/ntk148v/til/blob/master/docker/networking/README.md>Docker network note</a>. I will only show iptables packet flow: For example, we have a host with ip 10.0.10.26, then start a container that is exposed port 8000 to internet.</p><figure class=figure><img src=/photos/docker-iptables/docker-iptables-1.png></figure><p>This is a basic packet flow from outside:</p><figure class=figure><img src=/photos/docker-iptables/docker-iptables-2.png></figure><h2 id=you-may-do-it-wrong---common-mistakes>You may do it wrong - common mistakes</h2><p>Alright, before we make it right, there are some common mistakes.</p><h3 id=modify-docker-generated-rules-manually>Modify Docker generated rules manually</h3><p>Docker generates iptables rules, then adds to <code>DOCKER</code> chains. Some users may manipulate this chain manually in order to block connections.</p><p><em>Please don&rsquo;t do it</em>. Yes, you are able to do it, there is nothing prevent you to perform this kind of action. But every time Docker daemon is reloaded, iptables rules are re-generated and your changes is gone.</p><blockquote><p><strong>Right</strong>: Do not manipulate Docker rules manually.</p></blockquote><h3 id=insert-you-rules-in-the-wrong-chain>Insert you rules in the wrong chain</h3><p>iptables basic: iptables is divied into three levels: tables, chains and rules. We only use the filter tables, which contains:</p><ul><li>INPUT: Packets sent to this host pass through this chain.</li><li>OUTPUT: Packets sent from this host pass through this chain.</li><li>FORWARD: Packets forwarded by this host pass through this chain.</li></ul><p>Commonly, to block connection from external, put reject rules in INPUT chain. But in Docker, it doesn&rsquo;t work. Look at the above packet flow, the packet doesn&rsquo;t pass through INPUT chain, it goes in FORWARD chain. Since Docker connects the bridge (default docker0) to the default gateway (external interface ens33 for example) via Network Address Translation (NAT) by default, setting INPUT is useless and the FORWARD chain should be set. And since the FORWARD chain defaults to DROP, all forwarding is blocked by DOCKER-USER.</p><blockquote><p><strong>Right</strong>: Add rules which load before Docker&rsquo;s rules, add them to DOCKER-USER.</p></blockquote><h3 id=modify-and-persistent-iptables-wrong>Modify and persistent iptables wrong</h3><p>You modify and persistent iptables rules like this:</p><ul><li>Save all rules <code>iptables-save</code>.</li><li>Modify your rules.</li><li>Restore all rules with <code>iptables-restore</code>.</li><li>Persistent and load on start up using iptables-services or rc.local.</li></ul><p>This implementation has a drawback, every time Docker container changes, you need to save the current iptables configuration, otherwise when executing <code>iptables-restore</code>, it will load the old rules, which will lead to confusing iptables rules.</p><blockquote><p><strong>Right</strong>: Do not save, flush then restore all rules. Check the following solution.</p></blockquote><h2 id=do-it-right>Do it right!</h2><h3 id=overview>Overview</h3><p>I have create a repository for this, which is highly inspired by <a href=https://github.com/boTux-fr/systemd-service-iptables>systemd-service-iptables</a>: <a href=https://github.com/ntk148v/systemd-iptables>https://github.com/ntk148v/systemd-iptables</a></p><ul><li><p>Whitelist strategy: block all, allow some.</p></li><li><p><code>iptables-restore -n|--no-flush</code> turns off implicit global refresh and only performs our manual explicit refresh: only modified chains are flushed.</p></li><li><p>Control iptables with systemd: start iptables after other services.</p><ul><li>iptables.service.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Documentation=man:iptables man:iptables-restore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Type=oneshot
</span></span><span style=display:flex><span>ExecStart=/bin/true
</span></span><span style=display:flex><span>RemainAfterExit=on
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=multi-user.target
</span></span></code></pre></div><ul><li>iptables@.service.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>DefaultDependencies=no
</span></span><span style=display:flex><span>Wants=network-pre.target
</span></span><span style=display:flex><span>Wants=systemd-modules-<span style=font-weight:700;font-style:italic>load</span>.service
</span></span><span style=display:flex><span>Wants=local-fs.target
</span></span><span style=display:flex><span>Before=network-pre.target
</span></span><span style=display:flex><span>Before=shutdown.target
</span></span><span style=display:flex><span>After=systemd-modules-<span style=font-weight:700;font-style:italic>load</span>.service
</span></span><span style=display:flex><span>After=local-fs.target
</span></span><span style=display:flex><span>After=dbus.service
</span></span><span style=display:flex><span>After=polkit.service
</span></span><span style=display:flex><span>PartOf=iptables.service
</span></span><span style=display:flex><span>Conflicts=shutdown.target
</span></span><span style=display:flex><span>ConditionPathExists=/etc/iptables/
</span></span><span style=display:flex><span>Documentation=man:iptables man:iptables-restore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Environment=IPTABLES_RULES=/etc/iptables/%i.rules
</span></span><span style=display:flex><span>Environment=IPTABLES_RULES_FLUSH=/etc/iptables/%i.rules.empty
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Type=oneshot
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Start iptables-restore with no-flush option with %i.rules</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># NoFlush option (-n) is used to not flush other tables than %I.</span>
</span></span><span style=display:flex><span>ExecStart=/sbin/iptables-restore -v -n $IPTABLES_RULES
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Reload the rules</span>
</span></span><span style=display:flex><span>ExecReload=/sbin/iptables-restore -v -n $IPTABLES_RULES
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Stop and clean with empty rules</span>
</span></span><span style=display:flex><span>ExecStop=/sbin/iptables-restore -v -n $IPTABLES_RULES_FLUSH
</span></span><span style=display:flex><span>RemainAfterExit=yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=multi-user.target
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Need /etc/iptables/base.rules to exist.</span>
</span></span><span style=display:flex><span>DefaultInstance=base
</span></span></code></pre></div></li><li><p>Templating so nobody can&rsquo;t go wrong:</p><ul><li>base.rules.empty.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>*filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Reset counters
</span></span><span style=display:flex><span>:INPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:FORWARD DROP [0:0]
</span></span><span style=display:flex><span>:OUTPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:DOCKER-USER - [0:0]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Flush
</span></span><span style=display:flex><span>-F INPUT
</span></span><span style=display:flex><span>-F OUTPUT
</span></span><span style=display:flex><span>-F DOCKER-USER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COMMIT
</span></span></code></pre></div><ul><li>base.rules.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>*filter
</span></span><span style=display:flex><span># Reset counters
</span></span><span style=display:flex><span>:INPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:FORWARD DROP [0:0]
</span></span><span style=display:flex><span>:OUTPUT ACCEPT [0:0]
</span></span><span style=display:flex><span>:DOCKER-USER - [0:0]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Flush
</span></span><span style=display:flex><span>-F INPUT
</span></span><span style=display:flex><span>-F OUTPUT
</span></span><span style=display:flex><span>-F DOCKER-USER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#########
</span></span><span style=display:flex><span># INPUT #
</span></span><span style=display:flex><span>#########
</span></span><span style=display:flex><span># Accept on localhost
</span></span><span style=display:flex><span>-A INPUT -i lo -m comment --comment &#34;Default: Accept loopback&#34; -j ACCEPT
</span></span><span style=display:flex><span># Accept on Docker bridge
</span></span><span style=display:flex><span>-A INPUT -i br+ -m comment --comment &#34;Default: Accept bridge networks&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A INPUT -i docker0 -m comment --comment &#34;Default: Accept docker0&#34; -j ACCEPT
</span></span><span style=display:flex><span># Allow established sessions to receive traffic
</span></span><span style=display:flex><span>-A INPUT -m state --state RELATED,ESTABLISHED -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A INPUT -p icmp -m comment --comment &#34;Default: Accept ICMP&#34; -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Insert your INPUT ACCEPT rules here
</span></span><span style=display:flex><span># For example:
</span></span><span style=display:flex><span># Open https port only for 1 ip:
</span></span><span style=display:flex><span># -A INPUT -s 10.1.1.1/32 -p tcp -m tcp --dport 443 -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># By default reject all packets and leave a logging
</span></span><span style=display:flex><span>-A INPUT -m comment --comment &#34;Default: Log INPUT dropped packets&#34; -j LOG --log-prefix &#34;iptables INPUT DROP &#34; --log-level 7
</span></span><span style=display:flex><span>-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>##########
</span></span><span style=display:flex><span># OUTPUT #
</span></span><span style=display:flex><span>##########
</span></span><span style=display:flex><span># Accept on localhost
</span></span><span style=display:flex><span>-A OUTPUT -o lo -j ACCEPT
</span></span><span style=display:flex><span># Accept Docker networks
</span></span><span style=display:flex><span>-A OUTPUT -o br+ -m comment --comment &#34;Default: Accept bridge networks&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A OUTPUT -o docker0 -m comment --comment &#34;Default: Accept docker0&#34; -j ACCEPT
</span></span><span style=display:flex><span># Allow established sessions to receive traffic
</span></span><span style=display:flex><span>-A OUTPUT -m state --state RELATED,ESTABLISHED -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Insert your OUTPUT ACCEPT rules here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># By default reject all packets and leave a logging
</span></span><span style=display:flex><span>-A OUTPUT -m comment --comment &#34;Default: Log OUTPUT dropped packets&#34; -j LOG --log-prefix &#34;iptables OUTPUT DROP &#34; --log-level 7
</span></span><span style=display:flex><span>-A OUTPUT -j REJECT --reject-with icmp-host-prohibited
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>###############
</span></span><span style=display:flex><span># DOCKER-USER #
</span></span><span style=display:flex><span>###############
</span></span><span style=display:flex><span># Change your external interface here!
</span></span><span style=display:flex><span># Allow established sessions to receive traffic
</span></span><span style=display:flex><span>-A DOCKER-USER -i extinf -m state --state established,related -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A DOCKER-USER -i extinf -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A DOCKER-USER -o extinf -m state --state established,related -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>-A DOCKER-USER -o extinf -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment &#34;Default: Accept RELATED, ESTABLISHED connections&#34; -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Insert your DOCKER-USER ACCEPT rules here
</span></span><span style=display:flex><span># Note that you have to use conntrack and ctorigdstport due to NAT.
</span></span><span style=display:flex><span># For example:
</span></span><span style=display:flex><span># Allow all on http
</span></span><span style=display:flex><span># -A DOCKER-USER -i ens192 -p tcp -m tcp -m conntrack --ctorigdstport 80 -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># By default reject all packets
</span></span><span style=display:flex><span>-A DOCKER-USER -i extinf -m comment --comment &#34;Default: Log DROP-USER input dropped packets in external inteface&#34; -j LOG --log-prefix &#34;iptables DOCKER-USER INPUT DROP in external interface&#34; --log-level 7
</span></span><span style=display:flex><span>-A DOCKER-USER -i extinf -j REJECT
</span></span><span style=display:flex><span>-A DOCKER-USER -o extinf -m comment --comment &#34;Default: Log DROP-USER output dropped packets in external inteface&#34; -j LOG --log-prefix &#34;iptables DOCKER-USER OUTPUT DROP in external interface&#34; --log-level 7
</span></span><span style=display:flex><span>-A DOCKER-USER -o extinf -j REJECT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-A DOCKER-USER -j RETURN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>## Commit
</span></span><span style=display:flex><span>COMMIT
</span></span></code></pre></div></li></ul><h3 id=getting-started>Getting started</h3><ul><li>Ofc you need iptables and systemd installed.</li><li>On the Linux, run as root:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/ntk148v/systemd-iptables
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>cd</span> systemd-iptables
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Edit the rules in etc/iptables/base.rules as needed.</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># and install the service</span>
</span></span><span style=display:flex><span>cp -Rv etc/. /etc/
</span></span></code></pre></div><ul><li>Make changes in <code>/etc/iptables/base.rules</code>.<ul><li>Replace the placeholder <code>extinf</code> interface in the rulebook with your actual external interface (<code>eth0</code> for e.x).</li><li>Add your custom allow rules in the right place!<ul><li>Allow inbound connections -> INPUT Custom Accept Block.</li><li>Allow outbound connections -> OUTPUT Custom Accept Block.</li><li>Allow inbound/outbound connections to your Docker containers using network bridge -> DOCKER-USER Custom Accept Block.</li></ul></li></ul></li><li>After that, enable the serivces and we are done:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl <span style=font-weight:700;font-style:italic>enable</span> iptables.service
</span></span><span style=display:flex><span>systemctl <span style=font-weight:700;font-style:italic>enable</span> iptables@base.service
</span></span><span style=display:flex><span>systemctl start iptables@base.service
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># Check status</span>
</span></span><span style=display:flex><span>systemctl status iptables@base.service
</span></span></code></pre></div><ul><li>If you make any changes in the future, make sure to restart/reload your service.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart iptables@base.service
</span></span></code></pre></div><h2 id=references>References</h2><ol><li><a href=https://docs.docker.com/network/iptables/>https://docs.docker.com/network/iptables/</a></li><li><a href=https://github.com/boTux-fr/systemd-service-iptables>https://github.com/boTux-fr/systemd-service-iptables</a></li></ol><time datetime=2022-10-25>2022-10-25&nbsp;</time><div class=terminal-nav><div class=back-nav><a href=../ class=back-link>../</a></div></div></main><footer><p>&copy; Copyright 2025 &#183;
<a href=https://github.com/ntk148v/shibui>shibui</a></p></footer></body></html>